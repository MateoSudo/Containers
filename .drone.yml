kind: pipeline
type: docker
name: torrent-media-stack

# Only trigger when files in Torrent/ folder change
trigger:
  paths:
    include:
    - "Torrent/**"
  event:
  - push
  - pull_request

steps:
# =============================================================================
# VALIDATION STEPS
# =============================================================================

- name: validate-compose
  image: alpine:latest
  commands:
  - cd Torrent
  - echo "ğŸ” Validating podman-compose.yml structure..."
  - |
    if [ ! -f podman-compose.yml ]; then
      echo "âŒ podman-compose.yml not found"
      exit 1
    fi
  - echo "âœ… Compose file exists"

- name: check-env-template
  image: alpine:latest
  commands:
  - cd Torrent
  - echo "ğŸ” Checking environment template..."
  - |
    if [ ! -f .env.example ]; then
      echo "âŒ Missing .env.example"
      exit 1
    fi
  - echo "âœ… Environment template exists"
  - echo "ğŸ“‹ Required variables:"
  - grep "^[^#]" .env.example || true

- name: security-scan
  image: alpine:latest
  commands:
  - cd Torrent
  - echo "ğŸ”’ Security scan of compose file..."
  - |
    if grep -i "password\|secret\|key" podman-compose.yml | grep -v "from_secret\|_FILE"; then
      echo "âš ï¸  Warning: Potential secrets found in compose file"
      echo "ğŸ’¡ Consider using environment variables or secrets"
    else
      echo "âœ… No hardcoded secrets detected"
    fi

- name: validate-ports
  image: alpine:latest
  commands:
  - cd Torrent
  - echo "ğŸŒ Validating port configuration..."
  - |
    echo "ğŸ“‹ Exposed ports:"
    grep -E "^\s*-\s*\"[0-9]+:[0-9]+\"" podman-compose.yml || true
    echo "âœ… Port validation complete"

- name: validate-storage
  image: alpine:latest
  commands:
  - echo "ğŸ’¾ Validating storage configuration..."
  - |
    echo "ğŸ“‚ Required storage paths:"
    echo "  â€¢ /mnt/truenas (TrueNAS external storage)"
    echo "  â€¢ Local container volumes"
    echo ""
    echo "âš ï¸  Note: Ensure /mnt/truenas is properly mounted on host"
    echo "âœ… Storage validation complete"

# =============================================================================
# DEPLOYMENT STEPS
# =============================================================================

- name: deploy-staging
  image: alpine:latest
  commands:
  - echo "ğŸš€ Deploying to staging environment"
  - cd Torrent
  - echo "ğŸ“¦ Services to deploy:"
  - echo "  â€¢ PIA VPN (Private Internet Access)"
  - echo "  â€¢ QBittorrent (Torrent client)"
  - echo "  â€¢ Sonarr (TV series management)"
  - echo "  â€¢ Radarr (Movie management)"
  - echo "  â€¢ Lidarr (Music management)"
  - echo "  â€¢ Prowlarr (Indexer management)"
  - echo "  â€¢ Jellyfin (Media server)"
  - echo ""
  - echo "ï¿½ Storage Requirements:"
  - echo "  â€¢ TrueNAS mount: /mnt/truenas"
  - echo "  â€¢ Container volumes for configs"
  - echo ""
  - echo "ï¿½ğŸ’¡ Manual deployment required on host:"
  - echo "   cd /path/to/Torrent && your-start-script.sh"
  when:
    branch:
    - develop
    - feature/*

- name: deploy-production
  image: alpine:latest
  commands:
  - echo "ğŸ¬ Deploying Torrent Media Stack to production"
  - cd Torrent
  - echo ""
  - echo "ğŸ“Š Stack Overview:"
  - echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  - echo "â”‚ Service             â”‚ Port     â”‚ Function                â”‚"
  - echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
  - echo "â”‚ PIA VPN             â”‚ N/A      â”‚ Network protection      â”‚"
  - echo "â”‚ QBittorrent         â”‚ 8080     â”‚ Torrent downloads       â”‚"
  - echo "â”‚ Sonarr              â”‚ 8989     â”‚ TV show automation      â”‚"
  - echo "â”‚ Radarr              â”‚ 7878     â”‚ Movie automation        â”‚"
  - echo "â”‚ Lidarr              â”‚ 8686     â”‚ Music automation        â”‚"
  - echo "â”‚ Prowlarr            â”‚ 9696     â”‚ Indexer management      â”‚"
  - echo "â”‚ Jellyfin            â”‚ 8096     â”‚ Media streaming         â”‚"
  - echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
  - echo ""
  - echo "ğŸ’¾ Storage Configuration:"
  - echo "  â€¢ TrueNAS: /mnt/truenas (external NAS storage)"
  - echo "  â€¢ Downloads: Mapped to TrueNAS"
  - echo "  â€¢ Media Library: Served from TrueNAS to Jellyfin"
  - echo ""
  - echo "ğŸ”§ To deploy on host, run your container start script"
  - echo "âœ… Validation complete - Ready for deployment!"
  when:
    branch:
    - main

# =============================================================================
# NOTIFICATION STEPS
# =============================================================================

- name: notify-success
  image: alpine:latest
  commands:
  - echo "âœ… Torrent Media Stack pipeline completed successfully!"
  - echo "ğŸ¯ Branch: $DRONE_BRANCH"
  - echo "ğŸ‘¤ Author: $DRONE_COMMIT_AUTHOR"
  - echo "ğŸ“ Commit: $DRONE_COMMIT"
  - echo "â±ï¸  Build: #$DRONE_BUILD_NUMBER"
  when:
    status: [ success ]

- name: notify-failure
  image: alpine:latest
  commands:
  - echo "âŒ Torrent Media Stack pipeline failed!"
  - echo "ğŸ”— Branch: $DRONE_BRANCH"
  - echo "ğŸ‘¤ Author: $DRONE_COMMIT_AUTHOR"
  - echo "ğŸ“ Commit: $DRONE_COMMIT"
  - echo "ğŸ”— Build: #$DRONE_BUILD_NUMBER"
  when:
    status: [ failure ]
