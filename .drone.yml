kind: pipeline
type: docker
name: containers-test

steps:
- name: hello-world
  image: alpine:latest
  commands:
  - echo "ğŸ‰ Drone CI/CD is working!"
  - echo "Repository Containers"
  - ls -la

- name: check-torrent
  image: alpine:latest
  commands:
  - echo "Checking Torrent directory"
  - ls -la Torrent/
  - cd Torrent
  - ls -la
  - if [ ! -f .env.example ]; then echo "âŒ Missing .env.example"; exit 1; fi
  - echo "âœ… Torrent environment template exists"
  when:
    paths:
      include:
      - "Torrent/**"

- name: torrent-security-scan
  image: alpine:latest
  commands:
  - cd Torrent
  - echo "ğŸ” Checking for secrets in compose file..."
  - |
    if grep -q "password\|secret" podman-compose.yml; then
      echo "âš ï¸  Warning: Potential secrets found in compose file"
    else
      echo "âœ… No hardcoded secrets detected"
    fi
  when:
    paths:
      include:
      - "Torrent/**"

- name: torrent-deploy-staging
  image: alpine:latest
  commands:
  - echo "ğŸš€ Would deploy Torrent stack to staging environment"
  - cd Torrent
  - echo "podman-compose -f podman-compose.yml up -d"
  when:
    branch:
    - develop
    - feature/*
    paths:
      include:
      - "Torrent/**"

- name: torrent-deploy-production
  image: alpine:latest
  commands:
  - echo "ğŸš€ Deploying Torrent stack to production environment"
  - cd Torrent
  - echo "podman-compose -f podman-compose.yml up -d"
  # Add actual deployment commands here
  when:
    branch:
    - main
    paths:
      include:
      - "Torrent/**"

# =============================================================================
# WEBAPP PIPELINE (Future)
# =============================================================================

- name: webapp-install-dependencies
  image: node:18-alpine
  commands:
  - cd WebApp
  - npm install
  - echo "âœ… WebApp dependencies installed"
  when:
    paths:
      include:
      - "WebApp/**"

- name: webapp-test
  image: node:18-alpine
  commands:
  - cd WebApp
  - npm test
  - echo "âœ… WebApp tests passed"
  when:
    paths:
      include:
      - "WebApp/**"

- name: webapp-build
  image: node:18-alpine
  commands:
  - cd WebApp
  - npm run build
  - echo "âœ… WebApp built successfully"
  when:
    paths:
      include:
      - "WebApp/**"

- name: webapp-deploy
  image: alpine:latest
  commands:
  - echo "ğŸš€ Deploying WebApp..."
  - cd WebApp
  # Add deployment commands here
  when:
    branch:
    - main
    paths:
      include:
      - "WebApp/**"

# =============================================================================
# DATABASE PIPELINE (Future)
# =============================================================================

- name: database-validate
  image: postgres:15-alpine
  commands:
  - cd Database
  - echo "ğŸ” Validating database scripts..."
  # Add validation commands here
  when:
    paths:
      include:
      - "Database/**"

- name: database-migrate
  image: postgres:15-alpine
  commands:
  - cd Database
  - echo "ğŸš€ Running database migrations..."
  # Add migration commands here
  when:
    branch:
    - main
    paths:
      include:
      - "Database/**"

# =============================================================================
# DOCKER PIPELINE (Future)
# =============================================================================

- name: docker-build
  image: docker:latest
  commands:
  - cd Docker
  - echo "ğŸ³ Building Docker images..."
  # Add Docker build commands here
  when:
    paths:
      include:
      - "Docker/**"

# =============================================================================
# NOTIFICATION STEPS
# =============================================================================

- name: notify-success
  image: plugins/slack
  settings:
    webhook:
      from_secret: slack_webhook
    channel: deployments
    template: >
      âœ… **Containers Repository** build completed successfully!
      
      ğŸ”— **Branch**: {{build.branch}}
      ğŸ‘¤ **Author**: {{build.author}}
      ğŸ“ **Commit**: {{truncate build.commit 8}}
      â±ï¸ **Duration**: {{since build.started}}
  when:
    status: [ success ]

- name: notify-failure
  image: plugins/slack
  settings:
    webhook:
      from_secret: slack_webhook
    channel: deployments
    template: >
      âŒ **Containers Repository** build failed!
      
      ğŸ”— **Branch**: {{build.branch}}
      ğŸ‘¤ **Author**: {{build.author}}
      ğŸ“ **Commit**: {{truncate build.commit 8}}
      ğŸ”— **Build**: {{build.link}}
      â±ï¸ **Duration**: {{since build.started}}
  when:
    status: [ failure ]

---
kind: secret
name: slack_webhook
data: your_encrypted_slack_webhook_here
