kind: pipeline
type: docker
name: torrent-media-stack

# Only trigger when files in Torrent/ folder change
trigger:
  paths:
    include:
      - "Torrent/**"
  event:
    - push
    - pull_request

volumes:
  - name: podman-socket
    host:
      path: /run/podman/podman.sock

steps:
  # =============================================================================
  # OPTIMIZED VALIDATION (Single Container)
  # =============================================================================
  - name: validate-and-prepare
    image: alpine:latest
    commands:
      - cd Torrent
      - echo "üîç Running comprehensive validation and preparation..."
      - echo ""
      - echo "1. Validating podman-compose.yml structure..."
      - |
        if [ ! -f podman-compose.yml ]; then
          echo "‚ùå ERROR: podman-compose.yml not found"
          exit 1
        fi
        echo "‚úÖ SUCCESS: Compose file exists"
        
        # Quick syntax validation
        if grep -q "version:" podman-compose.yml && grep -q "services:" podman-compose.yml; then
          echo "‚úÖ SUCCESS: Basic YAML structure valid"
        else
          echo "‚ùå ERROR: Invalid compose file structure"
          exit 1
        fi
      - echo ""
      - echo "2. Environment configuration check..."
      - |
        if [ ! -f .env.example ]; then
          echo "‚ùå ERROR: Missing .env.example template"
          exit 1
        fi
        echo "‚úÖ SUCCESS: Environment template exists"
        
        # Check for required variables
        if grep -q "PIA_USER\|PIA_PASS" .env.example; then
          echo "‚úÖ SUCCESS: Required PIA variables found in template"
        else
          echo "‚ö†Ô∏è  WARNING: PIA credentials not found in template"
        fi
      - echo ""
      - echo "3. Security scan..."
      - |
        if grep -i "password\|secret\|key" podman-compose.yml | grep -v "from_secret\|_FILE\|\${.*}" | grep -q .; then
          echo "‚ö†Ô∏è  WARNING: Potential hardcoded secrets detected"
          echo "Consider using environment variables or secrets"
        else
          echo "‚úÖ SUCCESS: No hardcoded secrets detected"
        fi
      - echo ""
      - echo "4. Port configuration validation..."
      - |
        echo "Configured ports:"
        grep -E '^\s*-\s*"[0-9]+:[0-9]+"' podman-compose.yml | sed 's/.*"\([0-9]*\):\([0-9]*\)".*/  \1 -> \2/' || echo "  No direct port mappings found"
        echo "‚úÖ Port validation complete"
      - echo ""
      - echo "5. Storage and network validation..."
      - |
        echo "Storage requirements:"
        if grep -q "/mnt/truenas" podman-compose.yml; then
          echo "  ‚úÖ TrueNAS storage mapping found"
        else
          echo "  ‚ö†Ô∏è  No TrueNAS storage mapping detected"
        fi
        
        echo "Network configuration:"
        if grep -q "networks:" podman-compose.yml; then
          echo "  ‚úÖ Custom networks configured"
        else
          echo "  ‚ö†Ô∏è  Using default network"
        fi
        echo "‚úÖ Storage and network validation complete"
      - echo ""
      - echo "6. Service availability check..."
      - |
        echo "Configured services:"
        grep -E "^\s*[a-zA-Z][a-zA-Z0-9_-]*:" podman-compose.yml | sed 's/://g' | sed 's/^/  - /' || echo "  No services found"
        echo "‚úÖ Service configuration validated"
      - echo ""
      - echo "üéâ All validations passed successfully!"
      - echo ""
      - echo "üìã Deployment Summary:"
      - echo "Stack - Torrent Media Stack with VPN Protection"
      - echo "Services - PIA VPN, QBittorrent, Sonarr, Radarr, Lidarr, Prowlarr, Jellyfin"
      - echo "Storage - TrueNAS external mount + container volumes"
      - echo "Security - VPN-protected torrent traffic, isolated networks"

  # =============================================================================
  # STAGING DEPLOYMENT (Info Only)
  # =============================================================================
  - name: deploy-staging
    image: alpine:latest
    commands:
      - cd Torrent
      - echo "üìã Staging Environment Overview"
      - echo ""
      - echo "Services Configuration:"
      - echo "  PIA VPN         | N/A      | Network protection & routing"
      - echo "  QBittorrent     | 8083     | Torrent downloads (VPN protected)"
      - echo "  Sonarr          | 8989     | TV series automation"
      - echo "  Radarr          | 7878     | Movie automation"
      - echo "  Lidarr          | 8686     | Music automation"
      - echo "  Prowlarr        | 9696     | Indexer management"
      - echo "  Jellyfin        | 8096     | Media streaming server"
      - echo ""
      - echo "Network Architecture:"
      - echo "  Internet ‚Üê VPN ‚Üê PIA Container ‚Üê QBittorrent (protected)"
      - echo "  Internet ‚Üê Host Network ‚Üê Other Services (direct)"
      - echo ""
      - echo "Storage Layout:"
      - echo "  /mnt/truenas/downloads/ ‚Üí QBittorrent downloads"
      - echo "  /mnt/truenas/media/     ‚Üí Jellyfin library source"
      - echo "  Container volumes       ‚Üí Service configurations"
      - echo ""
      - echo "‚ö†Ô∏è  Staging - Manual deployment required"
      - echo "   Command - podman-compose -f podman-compose.yml up -d"
    when:
      branch:
        - develop
        - feature/*

  # =============================================================================
  # PRODUCTION DEPLOYMENT (Automated)
  # =============================================================================
  - name: deploy-production
    image: alpine:latest
    volumes:
      - name: podman-socket
        path: /run/podman/podman.sock
    commands:
      - echo "üöÄ Starting Production Deployment..."
      - apk add --no-cache podman bash python3 py3-pip
      - pip3 install podman-compose
      - cd /drone/src/Torrent
      - echo ""
      - echo "üìÅ Available files:"
      - ls -la
      - echo ""
      - echo "üîß Preparing deployment..."
      - |
        # Create .env from template if it doesn't exist
        if [ ! -f .env ]; then
          if [ -f .env.example ]; then
            cp .env.example .env
            echo "‚úÖ Created .env from template"
            echo "‚ö†Ô∏è  Please ensure PIA credentials are configured in .env"
          else
            echo "‚ùå ERROR: No .env.example template found"
            exit 1
          fi
        else
          echo "‚úÖ .env file already exists"
        fi
      - echo ""
      - echo "üõë Stopping existing containers..."
      - |
        # Stop existing containers gracefully
        for container in pia-vpn qbittorrent sonarr radarr lidarr prowlarr jellyfin; do
          if podman ps -a --format "{{.Names}}" | grep -q "^${container}$"; then
            echo "  Stopping $container..."
            podman stop $container 2>/dev/null || true
            podman rm $container 2>/dev/null || true
          fi
        done
        echo "‚úÖ Cleanup complete"
      - echo ""
      - echo "üèóÔ∏è  Creating required directories..."
      - |
        # Create directories on host (if TrueNAS is mounted)
        mkdir -p /mnt/truenas/downloads/complete 2>/dev/null || echo "  Note: /mnt/truenas may not be mounted yet"
        mkdir -p /mnt/truenas/downloads/incomplete 2>/dev/null || echo "  Note: /mnt/truenas may not be mounted yet"
        mkdir -p /mnt/truenas/media/{tv,movies,music} 2>/dev/null || echo "  Note: /mnt/truenas may not be mounted yet"
        echo "‚úÖ Directory structure prepared"
      - echo ""
      - echo "üöÄ Starting Torrent Media Stack..."
      - |
        if command -v podman-compose >/dev/null 2>&1; then
          echo "Using podman-compose for deployment..."
          podman-compose up -d
        else
          echo "‚ö†Ô∏è  podman-compose not available, using fallback script..."
          if [ -f ./start-stack.sh ]; then
            chmod +x ./start-stack.sh
            bash ./start-stack.sh
          else
            echo "‚ùå ERROR: No deployment method available"
            exit 1
          fi
        fi
      - echo ""
      - echo "‚úÖ Deployment completed!"
      - echo ""
      - echo "üåê Service Access URLs:"
      - echo "  QBittorrent - http://$(hostname -i):8083"
      - echo "  Sonarr - http://$(hostname -i):8989"
      - echo "  Radarr - http://$(hostname -i):7878"
      - echo "  Lidarr - http://$(hostname -i):8686"
      - echo "  Prowlarr - http://$(hostname -i):9696"
      - echo "  Jellyfin - http://$(hostname -i):8096"
      - echo ""
      - echo "üîê Default QBittorrent credentials - admin/adminadmin"
      - echo "‚ö†Ô∏è  Change default passwords after first login!"
    when:
      branch:
        - main

  # =============================================================================
  # ENHANCED NOTIFICATIONS
  # =============================================================================
  - name: notify-success
    image: alpine:latest
    commands:
      - echo "‚úÖ Torrent Media Stack Pipeline - SUCCESS"
      - echo ""
      - echo "üìä Build Information:"
      - echo "  Branch    - $DRONE_BRANCH"
      - echo "  Author    - $DRONE_COMMIT_AUTHOR"
      - echo "  Commit    - ${DRONE_COMMIT:0:8}"
      - echo "  Build     - #$DRONE_BUILD_NUMBER"
      - echo "  Timestamp - $(date)"
      - echo ""
      - |
        if [ "$DRONE_BRANCH" = "main" ]; then
          echo "üöÄ Production deployment completed successfully!"
          echo "üåê Services should now be accessible via web interfaces"
          echo "üîí VPN protection active for torrent traffic"
        else
          echo "üìã Validation completed - ready for production deployment"
        fi
    when:
      status:
        - success

  - name: notify-failure
    image: alpine:latest
    commands:
      - echo "‚ùå Torrent Media Stack Pipeline - FAILED"
      - echo ""
      - echo "üìä Build Information:"
      - echo "  Branch    - $DRONE_BRANCH"
      - echo "  Author    - $DRONE_COMMIT_AUTHOR"
      - echo "  Commit    - ${DRONE_COMMIT:0:8}"
      - echo "  Build     - #$DRONE_BUILD_NUMBER"
      - echo "  Timestamp - $(date)"
      - echo ""
      - echo "üîç Check the build logs for detailed error information"
      - echo "üí° Common issues:"
      - echo "  - Missing .env.example file"
      - echo "  - Invalid podman-compose.yml syntax"
      - echo "  - Podman socket connection issues"
      - echo "  - Missing TrueNAS mount points"
    when:
      status:
        - failure
